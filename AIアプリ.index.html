<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI画像生成ゲーム「インスピレーション・クエスト」対戦モード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00ffff; /* Cyan */
            --secondary-color: #ff00ff; /* Magenta */
            --bg-color: #0a0a1a;
            --container-bg: #1a1a2e;
            --text-color: #e0e0e0;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--container-bg);
            border: 1px solid var(--primary-color);
            border-radius: 1rem;
            box-shadow: 0 0 20px var(--primary-color, 0.5);
            padding: 3rem 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .app-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.05), transparent),
                        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><g fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.03"><path opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm0-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm0-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm0-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm0-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm0-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm0-10v--9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm0-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z"/></g></g></svg>');
            z-index: -1;
        }

        .btn {
            font-family: 'Orbitron', sans-serif;
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--primary-color);
            border-radius: 0.5rem;
            background-color: transparent;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--primary-color);
        }
        
        .btn:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--secondary-color);
        }
        
        .hidden {
            display: none;
        }

        select, input[type="text"], input[type="range"], textarea {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--primary-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: var(--text-color);
            width: 100%;
        }
        
        textarea {
            resize: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: var(--container-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--secondary-color);
            text-align: center;
            max-width: 90%;
            width: 500px;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .score-circle .score-value {
            font-size: 2rem;
            line-height: 1;
        }
        .score-circle .score-text {
            font-size: 0.75rem;
        }

        .picture-frame {
            background: linear-gradient(45deg, #4a2c1a, #2c1a0e);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.5);
            border: 2px solid #654321;
        }
        .picture-frame img {
            border: 4px solid #f5deb3;
        }
    </style>
</head>
<body>

    <div id="app-container" class="app-container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="flex flex-col items-center gap-8">
            <h1 class="text-3xl sm:text-4xl orbitron text-center" style="text-shadow: 0 0 10px var(--primary-color);">インスピレーション・クエスト</h1>
            <p class="text-center max-w-2xl text-sm sm:text-base">お題の言葉を使わずに、説明文だけでAIに画像を生成させるゲームです。<br>あなたの表現力で、AIにどれだけお題を伝えられるか挑戦しよう！</p>
            
            <div class="w-full max-w-md space-y-6">
                 <div class="flex flex-col gap-2">
                    <label for="player-mode-select" class="orbitron">プレイモード</label>
                    <select id="player-mode-select" class="w-full">
                        <option value="single">一人で遊ぶ</option>
                        <option value="multiplayer">二人で対戦</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="game-mode-select" class="orbitron">ゲームモード</label>
                    <select id="game-mode-select" class="w-full">
                        <option value="normal">通常モード</option>
                        <option value="one-shot">一発勝負モード</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="genre-select" class="orbitron">ジャンル選択</label>
                    <select id="genre-select" class="w-full">
                        <option value="all">オールジャンル</option>
                        <option value="ai_topic">AIにおまかせ ✨</option>
                        <option value="anime">アニメ・漫画</option>
                        <option value="animals">動物</option>
                        <option value="landmarks">世界のランドマーク</option>
                        <option value="foods">食べ物</option>
                        <option value="historicalFigures">歴史上の人物</option>
                        <option value="movies">映画</option>
                        <option value="mythicalCreatures">伝説の生き物</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="time-limit" class="orbitron">制限時間: <span id="time-limit-value">180</span>秒</label>
                    <input type="range" id="time-limit" min="10" max="180" step="10" value="180" class="w-full">
                </div>
                <div class="flex flex-col gap-2">
                    <label for="difficulty-select" class="orbitron">採点モード</label>
                    <select id="difficulty-select" class="w-full">
                        <option value="spicy">辛口</option>
                        <option value="sweet">甘口</option>
                    </select>
                </div>
            </div>

            <button id="start-button" class="btn btn-secondary">ゲーム開始</button>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="hidden flex-col items-center gap-6">
            <h2 class="text-2xl orbitron">対戦相手を待っています...</h2>
            <p>このURLを友達に共有してください:</p>
            <div class="flex gap-2 w-full max-w-lg">
                <input type="text" id="share-url-input" readonly class="flex-grow">
                <button id="copy-url-button" class="btn">コピー</button>
            </div>
            <div class="loader"></div>
        </div>


        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-gray-700 pb-2 gap-2">
                <div class="text-center sm:text-left">
                    <p class="text-sm text-gray-400">ジャンル: <span id="game-genre"></span></p>
                    <div class="flex items-center gap-2">
                        <h2 class="text-xl sm:text-2xl orbitron">お題: <span id="game-topic-display"></span></h2>
                        <button id="hint-button" class="btn text-xs p-1">ヒント ✨</button>
                    </div>
                </div>
                <div class="text-center sm:text-right">
                    <p class="text-2xl sm:text-3xl orbitron" id="timer">03:00</p>
                </div>
            </header>

            <main class="grid md:grid-cols-2 gap-8">
                <!-- Player 1 (You) -->
                <div id="player1-area" class="flex flex-col gap-4">
                    <h3 class="text-lg sm:text-xl orbitron">あなた (<span id="player1-score" class="text-primary-color">0</span>点)</h3>
                    <div id="player1-input-area">
                        <p class="text-sm">お題の言葉は使わずに、AIに伝わるように説明してください。</p>
                        <textarea id="prompt-input" rows="5" class="w-full text-sm"></textarea>
                        <button id="generate-button" class="btn w-full mt-2">画像生成</button>
                    </div>
                    <div id="player1-result-area" class="w-full aspect-square bg-black/30 rounded-lg flex items-center justify-center border border-dashed border-gray-600">
                        <p class="text-gray-400 text-sm">ここに画像が生成されます</p>
                    </div>
                    <div id="player1-evaluation-area" class="w-full p-2 bg-black/30 rounded-lg min-h-[80px] flex items-center justify-center">
                         <p class="text-gray-400 text-sm">ここにAIの評価が表示されます</p>
                    </div>
                </div>
                <!-- Player 2 (Opponent) -->
                <div id="player2-area" class="flex flex-col gap-4">
                     <h3 class="text-lg sm:text-xl orbitron">対戦相手 (<span id="player2-score" class="text-secondary-color">0</span>点)</h3>
                     <div class="w-full aspect-square bg-black/30 rounded-lg flex items-center justify-center border border-dashed border-gray-600">
                        <div id="player2-result-area" class="w-full h-full flex items-center justify-center">
                            <p class="text-gray-400 text-sm">相手の画像を待っています...</p>
                        </div>
                    </div>
                     <div class="w-full p-2 bg-black/30 rounded-lg min-h-[80px] flex items-center justify-center">
                        <div id="player2-evaluation-area" class="w-full h-full flex items-center justify-center">
                            <p class="text-gray-400 text-sm">相手の評価を待っています...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="modal-overlay hidden">
            <div class="flex flex-col items-center gap-4">
                <div class="loader"></div>
                <p id="loading-text" class="orbitron text-lg">AIが思考中...</p>
            </div>
        </div>
        
        <!-- Hint Modal -->
        <div id="hint-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-xl orbitron mb-4">ヒント</h3>
                <p id="hint-text" class="mb-4"></p>
                <button id="close-hint-button" class="btn">閉じる</button>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="modal-overlay hidden">
            <div class="modal-content flex flex-col items-center gap-4">
                <h2 id="game-result-title" class="text-2xl sm:text-3xl orbitron"></h2>
                
                <div class="flex justify-around w-full">
                    <div class="flex flex-col items-center gap-2">
                        <h4 class="orbitron">あなた</h4>
                        <div id="final-image-frame-p1" class="picture-frame hidden">
                            <img id="final-image-display-p1" src="" alt="あなたの最終画像" class="w-32 h-32 sm:w-48 sm:h-48 object-contain">
                        </div>
                        <p id="final-score-p1" class="text-3xl orbitron text-primary-color">0</p>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <h4 class="orbitron">対戦相手</h4>
                        <div id="final-image-frame-p2" class="picture-frame hidden">
                            <img id="final-image-display-p2" src="" alt="相手の最終画像" class="w-32 h-32 sm:w-48 sm:h-48 object-contain">
                        </div>
                        <p id="final-score-p2" class="text-3xl orbitron text-secondary-color">0</p>
                    </div>
                </div>
                <p id="correct-answer" class="text-xl sm:text-2xl font-bold"></p>
                <div id="final-feedback-container" class="w-full mt-2 p-3 bg-black/30 rounded-lg text-left">
                    <h4 class="font-bold orbitron text-center mb-2">AIからの総評</h4>
                    <p id="final-feedback-text" class="text-sm">総評を生成中...</p>
                </div>
                <button id="play-again-button" class="btn">もう一度プレイ</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI Elements
        const setupScreen = document.getElementById('setup-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const gameScreen = document.getElementById('game-screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const hintModal = document.getElementById('hint-modal');
        const hintText = document.getElementById('hint-text');
        const closeHintButton = document.getElementById('close-hint-button');
        const gameOverModal = document.getElementById('game-over-modal');

        const playerModeSelect = document.getElementById('player-mode-select');
        const gameModeSelect = document.getElementById('game-mode-select');
        const genreSelect = document.getElementById('genre-select');
        const timeLimitInput = document.getElementById('time-limit');
        const timeLimitValue = document.getElementById('time-limit-value');
        const difficultySelect = document.getElementById('difficulty-select');
        const startButton = document.getElementById('start-button');
        const shareUrlInput = document.getElementById('share-url-input');
        const copyUrlButton = document.getElementById('copy-url-button');
        
        const gameGenre = document.getElementById('game-genre');
        const gameTopicDisplay = document.getElementById('game-topic-display');
        const hintButton = document.getElementById('hint-button');
        const timerDisplay = document.getElementById('timer');
        
        // Player 1 UI
        const player1ScoreDisplay = document.getElementById('player1-score');
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const player1ResultArea = document.getElementById('player1-result-area');
        const player1EvaluationArea = document.getElementById('player1-evaluation-area');

        // Player 2 UI
        const player2ScoreDisplay = document.getElementById('player2-score');
        const player2ResultArea = document.getElementById('player2-result-area');
        const player2EvaluationArea = document.getElementById('player2-evaluation-area');

        // Game Over UI
        const gameResultTitle = document.getElementById('game-result-title');
        const finalScoreP1 = document.getElementById('final-score-p1');
        const finalImageFrameP1 = document.getElementById('final-image-frame-p1');
        const finalImageDisplayP1 = document.getElementById('final-image-display-p1');
        const finalScoreP2 = document.getElementById('final-score-p2');
        const finalImageFrameP2 = document.getElementById('final-image-frame-p2');
        const finalImageDisplayP2 = document.getElementById('final-image-display-p2');
        const correctAnswerDisplay = document.getElementById('correct-answer');
        const finalFeedbackText = document.getElementById('final-feedback-text');
        const playAgainButton = document.getElementById('play-again-button');
        
        // --- Firebase & Game State ---
        let db, auth, userId, gameId;
        let gameUnsubscribe = null;
        let currentTopic = null;
        let timeRemaining = 180;
        let timerInterval = null;
        let isGenerating = false;
        let gameActive = false;
        let playerNumber = null;

        const topics = {
            anime: [
                { name: 'ドラえもん', en_name: 'Doraemon, a blue, round, robotic cat' },
                { name: 'ピカチュウ', en_name: 'Pikachu, a yellow electric mouse pokemon' },
                { name: 'トトロ', en_name: 'Totoro, a giant, furry, grey forest spirit' },
                { name: 'アンパンマン', en_name: 'Anpanman, a superhero with a head made of bread' },
                { name: 'ルフィ', en_name: 'Luffy from One Piece, a boy with a straw hat and rubber powers' }
            ],
            animals: [
                { name: 'パンダ', en_name: 'Panda, a black and white bear that eats bamboo' },
                { name: 'キリン', en_name: 'Giraffe, a tall African animal with a very long neck' },
                { name: 'ペンギン', en_name: 'Penguin, a black and white flightless bird from Antarctica' },
                { name: 'カピバラ', en_name: 'Capybara, the worlds largest rodent, known for being calm' },
                { name: 'フラミンゴ', en_name: 'Flamingo, a pink bird that stands on one leg' }
            ],
            landmarks: [
                { name: '東京タワー', en_name: 'Tokyo Tower, a red and white communication tower in Japan' },
                { name: 'エッフェル塔', en_name: 'Eiffel Tower, a wrought-iron lattice tower in Paris' },
                { name: '自由の女神', en_name: 'Statue of Liberty, a colossal neoclassical sculpture on Liberty Island in New York Harbor' },
                { name: 'ピラミッド', en_name: 'The Great Pyramid of Giza, an ancient stone structure in Egypt' },
                { name: '富士山', en_name: 'Mount Fuji, a snow-capped volcano, the tallest peak in Japan' }
            ],
            foods: [
                { name: '寿司', en_name: 'Sushi, a Japanese dish of prepared vinegared rice, usually with some seafood' },
                { name: 'ラーメン', en_name: 'Ramen, a Japanese noodle soup' },
                { name: 'カレーライス', en_name: 'Curry Rice, a popular Japanese dish of rice with curry sauce' },
                { name: 'ピザ', en_name: 'Pizza, an Italian dish' },
                { name: 'ハンバーガー', en_name: 'Hamburger, a sandwich with a meat patty' }
            ],
            historicalFigures: [
                { name: '織田信長', en_name: 'Oda Nobunaga, a Japanese daimyo of the Sengoku period' },
                { name: 'クレオパトラ', en_name: 'Cleopatra, the last active ruler of the Ptolemaic Kingdom of Egypt' },
                { name: 'アインシュタイン', en_name: 'Albert Einstein, a physicist with wild white hair' },
                { name: '坂本龍馬', en_name: 'Sakamoto Ryoma, a prominent samurai from the Bakumatsu period in Japan' },
                { name: 'ジャンヌ・ダルク', en_name: 'Joan of Arc, a young woman in armor, holding a banner' }
            ],
            movies: [
                { name: 'E.T.', en_name: 'E.T. the Extra-Terrestrial, a small brown alien with a glowing finger' },
                { name: 'ダース・ベイダー', en_name: 'Darth Vader from Star Wars, a tall figure in black armor with a flowing cape and a red lightsaber' },
                { name: 'デロリアン', en_name: 'DeLorean time machine from Back to the Future, a sports car with gull-wing doors' },
                { name: 'ハリー・ポッター', en_name: 'Harry Potter, a young wizard with a lightning bolt scar on his forehead' },
                { name: 'タイタニック号', en_name: 'The Titanic, a massive ocean liner sinking in the icy Atlantic' }
            ],
            mythicalCreatures: [
                { name: 'ドラゴン', en_name: 'Dragon, a large, serpent-like legendary creature that appears in the folklore of many cultures worldwide' },
                { name: 'ユニコーン', en_name: 'Unicorn, a legendary creature that has been described since antiquity as a beast with a single large, pointed, spiraling horn projecting from its forehead' },
                { name: '河童', en_name: 'Kappa, a reptilian humanoid creature with a water-filled dish on its head' },
                { name: 'フェニックス', en_name: 'Phoenix, a long-lived bird that cyclically regenerates or is otherwise born again from fire' },
                { name: 'ケンタウロス', en_name: 'Centaur, a creature from Greek mythology with the upper body of a human and the lower body and legs of a horse' }
            ]
        };
        
        // --- Firebase Initialization ---
        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDEbyf7BWN2kaRf07WR8jsvgG69GmLkiKA",
  authDomain: "ai-photo-generator-b40c1.firebaseapp.com",
  projectId: "ai-photo-generator-b40c1",
  storageBucket: "ai-photo-generator-b40c1.firebasestorage.app",
  messagingSenderId: "681992073585",
  appId: "1:681992073585:web:fe2553a7e26c981f2c46d0",
  measurementId: "G-QS1Y9C8CWH"
};
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    checkUrlForGame();
                } else {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken).catch(error => {
                            console.error("Custom token sign-in failed, falling back to anonymous", error);
                            signInAnonymously(auth);
                        });
                    } else {
                        signInAnonymously(auth);
                    }
                }
            });
        }
        
        function checkUrlForGame() {
            const params = new URLSearchParams(window.location.search);
            const urlGameId = params.get('gameId');
            if (urlGameId) {
                joinGame(urlGameId);
            }
        }

        // --- API Call Functions ---
        const apiKey = "AIzaSyBpSvANMYdZ45yKl7K1-LxR7evx2HrJal0"; // APIキーは環境によって提供されます

        async function callGemini(prompt, isJson = false, schema = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema || {
                        type: "OBJECT",
                        properties: {
                            score: { type: "NUMBER" },
                            reason: { type: "STRING" }
                        },
                        required: ["score", "reason"]
                    }
                };
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                return isJson ? JSON.parse(text) : text;
            }
            throw new Error("API response was empty or invalid.");
        }

        async function callImagen(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { 
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            const result = await response.json();
            if (result.predictions && result.predictions.length > 0) {
                return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            }
            throw new Error("Image generation failed.");
        }

        // --- Game Logic ---
        async function handleStart() {
            if (playerModeSelect.value === 'single') {
                startSinglePlayerGame();
            } else {
                createMultiplayerGame();
            }
        }

        async function createMultiplayerGame() {
            startButton.disabled = true;
            startButton.textContent = 'ルーム作成中...';

            const gameSettings = await getGameSettings();
            if (!gameSettings) {
                 startButton.disabled = false;
                 startButton.textContent = '対戦ルーム作成';
                 return;
            }

            const newGameRef = doc(collection(db, `games`));
            gameId = newGameRef.id;

            const gameData = {
                ...gameSettings,
                status: 'waiting',
                createdAt: serverTimestamp(),
                player1: { id: userId, score: 0, imageUrl: '', prompt: '' },
                player2: { id: null, score: 0, imageUrl: '', prompt: '' }
            };

            await setDoc(newGameRef, gameData);
            
            const url = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
            shareUrlInput.value = url;
            
            setupScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');
            
            listenToGame(gameId);
        }

        async function joinGame(joinedGameId) {
            const gameRef = doc(db, 'games', joinedGameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists() && !gameSnap.data().player2.id) {
                gameId = joinedGameId;
                await updateDoc(gameRef, { 'player2.id': userId, status: 'active' });
                listenToGame(gameId);
            } else {
                alert("この対戦ルームは無効か、すでに満員です。");
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function listenToGame(id) {
            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(doc(db, 'games', id), (docSnap) => {
                const gameData = docSnap.data();
                if (!gameData) return;

                if (gameData.player1.id === userId) playerNumber = 1;
                else if (gameData.player2.id === userId) playerNumber = 2;

                if (gameData.status === 'active' && !gameActive) {
                    startMultiplayerGame(gameData);
                }
                
                if (gameActive) {
                    updateMultiplayerUI(gameData);
                }

                if (gameData.status === 'finished' && gameActive) {
                    endGame(gameData);
                }
            });
        }
        
        function updateMultiplayerUI(gameData) {
            const myData = playerNumber === 1 ? gameData.player1 : gameData.player2;
            const opponentData = playerNumber === 1 ? gameData.player2 : gameData.player1;

            player1ScoreDisplay.textContent = playerNumber === 1 ? myData.score : opponentData.score;
            player2ScoreDisplay.textContent = playerNumber === 2 ? myData.score : opponentData.score;
            
            if (opponentData.imageUrl) {
                player2ResultArea.innerHTML = `<img src="${opponentData.imageUrl}" class="w-full h-full object-contain rounded-lg">`;
            }
        }
        
        async function getGameSettings() {
            const selectedGenre = genreSelect.value;
            let topic;
            if (selectedGenre === 'ai_topic') {
                try {
                    const topicPrompt = `AI Topic Generation: You are a game master. Please generate a fun and challenging topic for an image generation game. The topic should be a well-known character, object, or place. Provide the topic in JSON format.`;
                    const schema = { type: "OBJECT", properties: { name: { type: "STRING" }, en_name: { type: "STRING" } }, required: ["name", "en_name"] };
                    topic = await callGemini(topicPrompt, true, schema);
                } catch(e) {
                    alert("AIお題の生成に失敗しました。");
                    return null;
                }
            } else {
                let genreForTopic = selectedGenre === 'all' ? Object.keys(topics)[Math.floor(Math.random() * Object.keys(topics).length)] : selectedGenre;
                const genreTopics = topics[genreForTopic];
                topic = genreTopics[Math.floor(Math.random() * genreTopics.length)];
            }

            return {
                gameMode: gameModeSelect.value,
                genre: selectedGenre,
                displayGenreName: genreSelect.options[genreSelect.selectedIndex].text,
                timeLimit: parseInt(timeLimitInput.value, 10),
                difficulty: difficultySelect.value,
                topic: topic
            };
        }

        function startMultiplayerGame(gameData) {
            gameActive = true;
            currentTopic = gameData.topic;
            timeRemaining = gameData.timeLimit;
            
            setupScreen.classList.add('hidden');
            waitingScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // UI Setup
            gameGenre.textContent = gameData.displayGenreName;
            gameTopicDisplay.textContent = gameData.topic.name;
            
            // Hide opponent's input area
            const player2Area = document.getElementById('player2-area');
            const player1InputArea = document.getElementById('player1-input-area');
            const player2InputArea = player2Area.querySelector('#player2-input-area');
            if(player2InputArea) player2InputArea.remove();
            
            // Rename player titles
            document.querySelector('#player1-area h3').innerHTML = `あなた (<span id="player1-score" class="text-primary-color">0</span>点)`;
            document.querySelector('#player2-area h3').innerHTML = `対戦相手 (<span id="player2-score" class="text-secondary-color">0</span>点)`;
            
            startTimer(true);
        }

        // --- Single Player Logic (simplified) ---
        async function startSinglePlayerGame() {
            const settings = await getGameSettings();
            if (!settings) return;
            
            currentTopic = settings.topic;
            timeRemaining = settings.timeLimit;
            gameActive = true;
            
            // UI setup for single player
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            document.getElementById('player2-area').classList.add('hidden');
            document.querySelector('#player1-area h3').textContent = 'スコア';
            document.getElementById('player1-score').textContent = '0';
            
            gameGenre.textContent = settings.displayGenreName;
            gameTopicDisplay.textContent = settings.topic.name;
            
            startTimer(false);
        }

        function startTimer(isMultiplayer) {
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(async () => {
                if (!gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                if (isMultiplayer && playerNumber === 1) { // Host controls the timer
                     const gameRef = doc(db, 'games', gameId);
                     const gameSnap = await getDoc(gameRef);
                     if(gameSnap.exists()) {
                       const currentServerTime = gameSnap.data().timeRemaining;
                       if (currentServerTime > 0) {
                          await updateDoc(gameRef, { timeRemaining: currentServerTime - 1 });
                       } else {
                          await updateDoc(gameRef, { status: 'finished' });
                       }
                     }
                } else { // Single player or client-side countdown
                    timeRemaining--;
                    updateTimerDisplay();
                    if (timeRemaining <= 0) {
                       clearInterval(timerInterval);
                       if (!isGenerating) endGame(null);
                    }
                }

            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const seconds = (timeRemaining % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
            if (timeRemaining <= 10 && timeRemaining > 0) {
                timerDisplay.style.color = 'var(--secondary-color)';
                timerDisplay.style.animation = 'pulse 1s infinite';
            } else {
                 timerDisplay.style.color = 'var(--text-color)';
                 timerDisplay.style.animation = 'none';
            }
        }

        async function handleGenerate() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt || isGenerating || !gameActive) return;
            
            isGenerating = true;
            generateButton.disabled = true;
            loadingOverlay.classList.remove('hidden');

            try {
                const translationPrompt = `Translate the following Japanese description into a vivid, detailed English prompt suitable for an image generation AI. Focus on visual details. Do not include the name "${currentTopic.name}" or "${currentTopic.en_name}". The final output must be only the English prompt itself. Japanese description: "${userPrompt}"`;
                const englishPrompt = await callGemini(translationPrompt);

                const finalImagePrompt = `${englishPrompt}, digital art, vibrant colors`;
                const imageUrl = await callImagen(finalImagePrompt);
                
                player1ResultArea.innerHTML = `<img src="${imageUrl}" alt="Generated Image" class="w-full h-full object-contain rounded-lg">`;

                const difficulty = difficultySelect.value;
                const evalPrompt = getEvalPrompt(difficulty);
                const evaluation = await callGemini(evalPrompt, true);
                const { score, reason } = evaluation;

                if (playerModeSelect.value === 'multiplayer') {
                    const updateData = {};
                    updateData[`player${playerNumber}.score`] = score;
                    updateData[`player${playerNumber}.imageUrl`] = imageUrl;
                    updateData[`player${playerNumber}.prompt`] = userPrompt;
                    await updateDoc(doc(db, 'games', gameId), updateData);
                } else {
                    player1ScoreDisplay.textContent = score;
                }
                
                const scoreColor = `hsl(${(score / 100) * 120}, 100%, 50%)`;
                player1EvaluationArea.innerHTML = `
                    <div class="flex items-center gap-4 w-full">
                        <div class="score-circle" style="background: radial-gradient(circle, ${scoreColor}33, transparent 70%); border: 3px solid ${scoreColor};">
                            <span class="score-value">${score}</span>
                            <span class="score-text">PTS</span>
                        </div>
                        <p class="flex-1 text-left text-sm">${reason}</p>
                    </div>`;

            } catch (error) {
                console.error(error);
                player1EvaluationArea.innerHTML = `<p class="text-red-400">エラーが発生しました: ${error.message}</p>`;
            } finally {
                isGenerating = false;
                loadingOverlay.classList.add('hidden');
                
                if (gameModeSelect.value === 'one-shot') {
                    if (playerModeSelect.value === 'multiplayer') {
                        // wait for opponent
                    } else {
                        endGame(null);
                    }
                } else if (gameActive) {
                    generateButton.disabled = false;
                }
            }
        }
        
        function getEvalPrompt(difficulty) {
            const base = `The secret theme is "${currentTopic.en_name}". Based on the provided image, provide a score from 0 to 100 and a brief, one-or-two-sentence reason for your score in Japanese. The reason must be abstract and based on the scoring criteria. It must NOT contain any specific hints about the secret theme. Your response must be in JSON format with "score" and "reason" keys.`;
            if (difficulty === 'spicy') {
                return `You are a very strict art critic. ${base} Scoring criteria: 100=perfect, 80-99=very good, 60-79=good, 40-59=fair, 20-39=poor, 0-19=wrong.`;
            }
            return `You are a friendly and encouraging art teacher. ${base} Scoring criteria: 100=fantastic, 80-99=great, 60-79=good effort, 40-59=nice try, 0-39=interesting.`;
        }

        async function handleGetHint() {
            if (isGenerating || !gameActive) return;
            hintButton.disabled = true;
            timeRemaining = Math.max(0, timeRemaining - 10);
            updateTimerDisplay();
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'ヒントを生成中...';
            try {
                const hintPrompt = `The secret topic is "${currentTopic.name} (${currentTopic.en_name})". Please provide a creative, one-sentence hint in Japanese that helps the user guess the topic without giving away the answer directly. Think of it like a riddle.`;
                const hint = await callGemini(hintPrompt);
                hintText.textContent = hint;
                hintModal.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('ヒントの生成に失敗しました。');
            } finally {
                loadingOverlay.classList.add('hidden');
                if (gameActive) hintButton.disabled = false;
            }
        }

        async function endGame(gameData) {
            if (!gameActive && playerModeSelect.value === 'multiplayer') return;
            gameActive = false;
            clearInterval(timerInterval);
            generateButton.disabled = true;
            hintButton.disabled = true;
            
            correctAnswerDisplay.textContent = `お題: 「${currentTopic.name}」`;

            if (playerModeSelect.value === 'multiplayer') {
                const p1 = gameData.player1;
                const p2 = gameData.player2;
                finalScoreP1.textContent = p1.score;
                finalScoreP2.textContent = p2.score;

                if (p1.imageUrl) {
                    finalImageDisplayP1.src = p1.imageUrl;
                    finalImageFrameP1.classList.remove('hidden');
                }
                if (p2.imageUrl) {
                    finalImageDisplayP2.src = p2.imageUrl;
                    finalImageFrameP2.classList.remove('hidden');
                }

                if (p1.score > p2.score) {
                    gameResultTitle.textContent = playerNumber === 1 ? "あなたの勝利！" : "あなたの負け...";
                } else if (p2.score > p1.score) {
                    gameResultTitle.textContent = playerNumber === 2 ? "あなたの勝利！" : "あなたの負け...";
                } else {
                    gameResultTitle.textContent = "引き分け";
                }
                // Feedback for the current player
                const myPrompt = playerNumber === 1 ? p1.prompt : p2.prompt;
                generateFinalFeedback(myPrompt);

            } else { // Single player
                gameResultTitle.textContent = "終了！";
                document.getElementById('final-score-p2').parentElement.classList.add('hidden');
                finalScoreP1.textContent = latestScore;
                if (lastGeneratedImageUrl) {
                    finalImageDisplayP1.src = lastGeneratedImageUrl;
                    finalImageFrameP1.classList.remove('hidden');
                }
                 generateFinalFeedback(lastUserPrompt);
            }
            
            gameOverModal.classList.remove('hidden');
        }
        
        async function generateFinalFeedback(userPrompt) {
             if (!userPrompt) {
                finalFeedbackText.textContent = '今回は画像が生成されませんでした。次回はぜひ挑戦してみてください！';
                return;
            }
            try {
                const feedbackPrompt = `あなたは画像生成ゲームのAIコーチです。正解のお題は「${currentTopic.name} (${currentTopic.en_name})」でした。プレイヤーが最後に入力したプロンプトは「${userPrompt}」です。このプロンプトをより良くするための、具体的で建設的なフィードバックを日本語で2〜3文で作成してください。例えば、どの特徴を加えればもっと良くなったか、どう表現すればより鮮明になったかなどを、励ますような口調で提案してください。`;
                const feedback = await callGemini(feedbackPrompt);
                finalFeedbackText.textContent = feedback;
            } catch (error) {
                console.error("Feedback generation failed:", error);
                finalFeedbackText.textContent = '総評の生成に失敗しました。';
            }
        }

        function resetGame() {
            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = null;
            gameId = null;
            playerNumber = null;
            
            gameOverModal.classList.add('hidden');
            gameScreen.classList.add('hidden');
            waitingScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            
            // Reset multiplayer specific UI
            document.getElementById('player2-area').classList.remove('hidden');
            document.getElementById('final-score-p2').parentElement.classList.remove('hidden');

            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- Event Listeners ---
        timeLimitInput.addEventListener('input', (e) => {
            timeLimitValue.textContent = e.target.value;
        });

        startButton.addEventListener('click', handleStart);
        generateButton.addEventListener('click', handleGenerate);
        hintButton.addEventListener('click', handleGetHint);
        closeHintButton.addEventListener('click', () => hintModal.classList.add('hidden'));
        playAgainButton.addEventListener('click', resetGame);
        copyUrlButton.addEventListener('click', () => {
            shareUrlInput.select();
            document.execCommand('copy');
            copyUrlButton.textContent = 'コピー完了！';
            setTimeout(() => { copyUrlButton.textContent = 'コピー'; }, 2000);
        });
        
        // --- Initial Load ---
        initializeFirebase();

    </script>
</body>
</html>
